<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tacrolimus Clinical Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/customParseFormat.js"></script>
    <script>
        dayjs.extend(dayjs_plugin_customParseFormat);
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .gradient-bg { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); }
        .card-shadow { box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05); }
        .input-focus:focus { box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2); border-color: #6366f1; }
        .status-indicator { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .level-high { background-color: #ef4444; }
        .level-target { background-color: #10b981; }
        .level-low { background-color: #f59e0b; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .output-success { color: #374151; }
        .output-error { color: #dc2626; font-weight: 500; }
        .output-info { color: #6b7280; font-style: italic; }
        .highlight-row { background-color: #ecfdf5 !important; border-left: 4px solid #10b981; }
    </style>
</head>
<body class="bg-slate-50 min-h-full">
    
    <header class="gradient-bg text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <h1 class="text-3xl font-bold">Tacrolimus Clinical Dashboard</h1>
            <p class="text-indigo-100 mt-1">Individualized Forecasting & Dose Optimization for Kidney Transplant</p>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8">
        
        <div class="bg-white rounded-xl card-shadow p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                <span class="bg-indigo-100 text-indigo-600 rounded-full p-2 mr-3">üë§</span> Patient & Model Information
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Row 1: Patient Name & Transplant Date -->
                <div class="md:col-span-2">
                    <label for="patient-name" class="block text-sm font-medium text-gray-700 mb-1">Patient Name</label>
                    <input list="patient-list" id="patient-name" placeholder="Select or type patient name..." class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus">
                    <datalist id="patient-list">
                        <!-- This will be populated by JavaScript with saved patient names -->
                    </datalist>
                </div>
                <div>
                    <label for="transplant-date" class="block text-sm font-medium text-gray-700 mb-1">Transplant Date</label>
                    <input id="transplant-date" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus">
                </div>

                <!-- Row 2: Clinical Params -->
                <div>
                    <label for="weight" class="block text-sm font-medium text-gray-700 mb-1">Weight (kg)</label>
                    <input type="number" id="weight" value="60" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus">
                </div>
                <div>
                    <label for="hematocrit" class="block text-sm font-medium text-gray-700 mb-1">Hematocrit (%)</label>
                    <input type="number" id="hematocrit" value="31" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus">
                </div>
                 <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Mycophenolic Acid</label>
                     <select id="mpa" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus">
                         <option value="1" selected>Yes</option>
                         <option value="0">No</option>
                     </select>
                </div>

                <!-- Row 3: Bioassay, Genotype & Forecast Date -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Bioassay Type</label>
                    <select id="bioassay" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus">
                        <option value="1">LC-MS/MS</option>
                        <option value="2">CMIA</option>
                    </select>
                </div>
                <div>
                    <label for="genotype" class="block text-sm font-medium text-gray-700 mb-1">CYP3A5 Genotype</label>
                    <select id="genotype" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus">
                        <option value="unknown" selected>Unknown (Default)</option>
                        <option value="33">CYP3A5*3/*3 (Slow)</option>
                        <option value="13">CYP3A5*1/*3 (Intermediate)</option>
                        <option value="11">CYP3A5*1/*1 (Fast)</option>
                    </select>
                </div>
                <div>
                    <label for="prediction-datetime" class="block text-sm font-medium text-gray-700 mb-1">Forecast Date & Time</label>
                    <input id="prediction-datetime" type="text" placeholder="Select date..." class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus">
                </div>
            </div>
            <!-- Row 4: Action Buttons -->
            <div class="flex flex-wrap gap-3 justify-end items-center mt-6 border-t border-gray-200 pt-4">
                <button onclick="exportPatientDataToCSV()" class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition-colors duration-200 text-sm font-medium">Export CSV</button>
                <button onclick="loadPatientData()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors duration-200 text-sm font-medium">Load Patient</button>
                <button onclick="savePatientData()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors duration-200 text-sm font-medium">Save Data</button>
                <button onclick="clearAllData(true)" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors duration-200 text-sm font-medium">Clear All</button>
            </div>
        </div>

        <div class="text-center">
            <button id="run-all-btn" class="w-full max-w-md bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-3 px-4 rounded-lg font-medium hover:from-indigo-700 hover:to-purple-700 transition-all duration-200 shadow-lg text-lg disabled:opacity-50 disabled:cursor-not-allowed">
                Run Individualized Forecast
            </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <div class="bg-white rounded-xl card-shadow p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                    <span class="bg-orange-100 text-orange-600 rounded-full p-2 mr-3">‚öóÔ∏è</span> Quick Hematocrit Adjustment
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                    <div>
                        <label for="quick-hct-level" class="block text-sm font-medium text-gray-700 mb-1">Initial Level (ng/mL)</label>
                        <input type="number" id="quick-hct-level" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus">
                    </div>
                    <div>
                        <label for="quick-hct-initial" class="block text-sm font-medium text-gray-700 mb-1">Initial HCT (%)</label>
                        <input type="number" id="quick-hct-initial" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus">
                    </div>
                    <div class="md:col-span-2">
                        <div id="quick-hct-output" class="text-center text-lg font-semibold p-3 bg-gray-50 rounded-lg">
                            Adjusted Level: --
                        </div>
                    </div>
                </div>
            </div>

            <!-- NEW: Model Parameters Card -->
            <div id="model-params-card" class="bg-white rounded-xl card-shadow p-6 hidden">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                     <span class="bg-blue-100 text-blue-600 rounded-full p-2 mr-3">‚öôÔ∏è</span> Model Parameters
                </h2>
                <div id="model-params-output" class="text-center text-gray-500 italic">
                    Run forecast to see parameters.
                </div>
            </div>

            <div id="ipv-card" class="bg-white rounded-xl card-shadow p-6 hidden">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                     <span class="bg-teal-100 text-teal-600 rounded-full p-2 mr-3">üìä</span> IPV & Metabolizer Status
                </h2>
                <div id="ipv-output" class="text-center text-gray-500 italic">
                    Requires at least 3 lab results to calculate.
                </div>
            </div>

             <div id="ttr-card" class="bg-white rounded-xl card-shadow p-6 hidden">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                     <span class="bg-purple-100 text-purple-600 rounded-full p-2 mr-3">‚è±Ô∏è</span> Time in Therapeutic Range
                </h2>
                <div id="ttr-output" class="text-center text-gray-500 italic">
                    Requires at least 2 lab results to calculate.
                </div>
            </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div class="bg-white rounded-xl card-shadow p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-800 flex items-center m-0">
                        <span class="bg-purple-100 text-purple-600 rounded-full p-2 mr-3">üíä</span> Dose Administration
                    </h2>
                    <button onclick="addDefaultDoseDay()" class="bg-indigo-500 text-white px-4 py-2 rounded-lg hover:bg-indigo-600 transition-colors duration-200 flex items-center shadow-sm text-sm">
                        + Log Dose Day
                    </button>
                </div>
                <div class="overflow-x-auto -mx-6">
                    <table class="w-full min-w-full">
                        <thead><tr class="border-b border-gray-200 text-left text-sm font-semibold text-gray-600">
                            <th class="py-3 px-4">Date & Time</th><th class="py-3 px-4">Dose (mg)</th><th class="py-3 px-4 text-right">Actions</th>
                        </tr></thead>
                        <tbody id="doseLogTable"></tbody>
                    </table>
                </div>
            </div>

            <div class="bg-white rounded-xl card-shadow p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-800 flex items-center m-0">
                        <span class="bg-green-100 text-green-600 rounded-full p-2 mr-3">üß™</span> Lab Results
                    </h2>
                    <button onclick="showAddRecordModal('level')" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors duration-200 flex items-center shadow-sm text-sm">
                        + Log Lab Result
                    </button>
                </div>
                <div class="overflow-x-auto -mx-6">
                    <table class="w-full min-w-full">
                        <thead><tr class="border-b border-gray-200 text-left text-sm font-semibold text-gray-600">
                            <th class="py-3 px-4">Date & Time</th><th class="py-3 px-4">Level (ng/mL)</th><th class="py-3 px-4">Status</th><th class="py-3 px-4 text-right">Actions</th>
                        </tr></thead>
                        <tbody id="levelLogTable"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="output-section" class="space-y-8 hidden">
            <div class="bg-white rounded-xl card-shadow p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center justify-center">
                    <span class="bg-cyan-100 text-cyan-600 rounded-full p-2 mr-3">üìà</span> Concentration Forecast
                </h2>
                <div class="relative h-96">
                    <canvas id="concentration-chart"></canvas>
                    <div id="forecast-loader" class="absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center hidden"><div class="loader"></div></div>
                </div>
                <div id="results-summary" class="mt-4 text-center font-semibold text-lg p-3 bg-gray-50 rounded-md hidden"></div>
            </div>

            <!-- NEW: Dose Optimizer Card -->
            <div id="dose-optimizer-card" class="bg-white rounded-xl card-shadow p-6 hidden">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                    <span class="bg-green-100 text-green-600 rounded-full p-2 mr-3">üéØ</span> Dose Optimizer Tool
                </h2>
                <div id="optimizer-inputs" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                    <div>
                        <label for="target-trough-input" class="block text-sm font-medium text-gray-700 mb-1">Target Trough (ng/mL)</label>
                        <input type="number" id="target-trough-input" value="8.0" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus">
                    </div>
                    <div>
                        <label for="target-date-input" class="block text-sm font-medium text-gray-700 mb-1">Target Date (at Trough)</label>
                        <input id="target-date-input" type="text" placeholder="Select date..." class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus">
                    </div>
                    <div class="md:pt-6">
                         <button id="run-optimizer-btn" class="w-full bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors duration-200 font-medium">
                            Find Optimal Dose
                        </button>
                    </div>
                </div>
                <div id="optimizer-output" class="mt-4">
                    <div class="text-center text-gray-500 italic">
                        Run the main forecast first to enable this tool.
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="addRecordModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4 card-shadow" id="modal-content">
            <h3 class="text-lg font-semibold text-gray-800 mb-4" id="modal-title">Add Record</h3>
            <div class="space-y-4">
                 <div>
                    <label for="newDateTime" class="block text-sm font-medium text-gray-700 mb-1">Date & Time</label>
                    <input type="text" id="newDateTime" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus">
                </div>
                <div id="dose-input-container">
                    <label for="newDose" class="block text-sm font-medium text-gray-700 mb-1">Dose (mg)</label>
                    <input type="number" step="0.1" id="newDose" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus">
                </div>
                <div id="level-input-container">
                    <label for="newLevel" class="block text-sm font-medium text-gray-700 mb-1">Level (ng/mL)</label>
                    <input type="number" step="0.1" id="newLevel" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus">
                </div>
            </div>
            <input type="hidden" id="editIndex">
            <input type="hidden" id="recordType">
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="hideAddRecordModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors font-medium rounded-lg">Cancel</button>
                <button id="save-record-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors font-medium">Save Record</button>
            </div>
        </div>
    </div>

<script>
// --- Global State & Configuration ---
let clinicalData = [];
let myChart = null;

// NEW: Store last forecast parameters for optimizer
let lastForecastParams = {
    individual: null,
    population: null,
    allDoses: [],
    patientData: null
};

// --- Pharmacokinetic Model Constants (UPDATED based on Indian context) ---
const PK_CONSTANTS = {
    // Population typical values for a 70kg person
    TVCL: 20.3,  // Typical Clearance (L/hr) - Validated for Asian/Indian population
    TVV:  451,   // Typical Volume of Distribution (L)
    TVKA: 1.81,  // Typical Absorption Rate Constant (1/hr)
    F: 0.137,    // 13.7% bioavailability

    // Hematocrit Adjustment constants (retained for Quick HCT Adjustment tool)
    HCT_ADJ_BMAX: 418, // Maximum binding capacity (ng/mL)
    HCT_ADJ_KD: 3.8    // Dissociation constant (ng/mL)
};

// --- NEW Genotype Multiplier Const ---
const CYP3A5_MULTIPLIER = {
    '11': 2.0,    // Fast metabolizer (10-15% in India)
    '13': 1.5,    // Intermediate (40-50% in India)
    '33': 1.0,    // Slow metabolizer (40-50% in India)
    'unknown': 1.2  // Conservative if not tested
};


// --- Initialization ---
document.addEventListener('DOMContentLoaded', function() {
    initializeUI();
    setupEventListeners();
    populatePatientList();
    setSmartDefaults(); 
    renderDoseLog();
    renderLevelLog();
});

function initializeUI() {
    flatpickr("#transplant-date", { altInput: true, altFormat: "d-M-y", dateFormat: "Y-m-d" });
    flatpickr("#prediction-datetime", { enableTime: true, altInput: true, altFormat: "d-M-y H:i", dateFormat: "Y-m-d H:i" });
    // NEW: Initialize optimizer date picker
    flatpickr("#target-date-input", { 
        enableTime: true, 
        altInput: true, 
        altFormat: "d-M-y H:i", 
        dateFormat: "Y-m-d H:i",
        defaultDate: dayjs().add(4, 'day').hour(7).minute(0).toDate() // Default to 4 days from now
    });
}

function setupEventListeners() {
    document.getElementById('run-all-btn').addEventListener('click', runAllAnalyses);
    // NEW: Optimizer button event
    document.getElementById('run-optimizer-btn').addEventListener('click', runDoseOptimizer);

    ['quick-hct-level', 'quick-hct-initial'].forEach(id => {
        document.getElementById(id).addEventListener('input', runQuickHctAdjustment);
    });
}

// --- Local Storage Management ---

function populatePatientList() {
    const patientList = JSON.parse(localStorage.getItem('tacrolimusPatientList') || '[]');
    const datalist = document.getElementById('patient-list');
    datalist.innerHTML = ''; // Clear existing options
    patientList.sort().forEach(patientName => {
        const option = document.createElement('option');
        option.value = patientName;
        datalist.appendChild(option);
    });
}

function savePatientData() {
    const patientName = document.getElementById('patient-name').value.trim();
    if (!patientName) {
        alert('Please enter a patient name to save data.');
        return;
    }
    
    // Use a case-insensitive key for storage
    const patientKey = patientName.toLowerCase();

    const dataToSave = {
        patient: {
            transplantDate: document.getElementById('transplant-date')._flatpickr.input.value,
            weight: document.getElementById('weight').value,
            hematocrit: document.getElementById('hematocrit').value,
            mpa: document.getElementById('mpa').value,
            bioassay: document.getElementById('bioassay').value,
            genotype: document.getElementById('genotype').value
        },
        clinicalData: clinicalData
    };
    
    localStorage.setItem(`tacrolimusDashboard_${patientKey}`, JSON.stringify(dataToSave));

    let patientList = JSON.parse(localStorage.getItem('tacrolimusPatientList') || '[]');
    if (!patientList.map(p => p.toLowerCase()).includes(patientKey)) {
        patientList.push(patientName); // Save the original cased name
        localStorage.setItem('tacrolimusPatientList', JSON.stringify(patientList));
        populatePatientList();
    }
    
    alert(`Data saved for patient: ${patientName}`);
}

function loadPatientData() {
    const patientName = document.getElementById('patient-name').value.trim();
    if (!patientName) {
        alert('Please select or type a patient name to load.');
        return;
    }
    
    const patientKey = patientName.toLowerCase();
    const savedData = localStorage.getItem(`tacrolimusDashboard_${patientKey}`);
    
    if (savedData) {
        const data = JSON.parse(savedData);
        const patientList = JSON.parse(localStorage.getItem('tacrolimusPatientList') || '[]');
        const properName = patientList.find(p => p.toLowerCase() === patientKey) || patientName;
        document.getElementById('patient-name').value = properName;
        
        document.getElementById('transplant-date')._flatpickr.setDate(data.patient.transplantDate, true);
        document.getElementById('weight').value = data.patient.weight || 60;
        document.getElementById('hematocrit').value = data.patient.hematocrit || 31;
        document.getElementById('mpa').value = data.patient.mpa || '1';
        document.getElementById('bioassay').value = data.patient.bioassay || '1';
        document.getElementById('genotype').value = data.patient.genotype || 'unknown';
        clinicalData = data.clinicalData || [];
        
        renderDoseLog();
        renderLevelLog();
        setSmartDefaults();
        
        // Hide output sections until 'run' is pressed
        document.getElementById('output-section').classList.add('hidden');
        document.getElementById('ipv-card').classList.add('hidden');
        document.getElementById('ttr-card').classList.add('hidden');
        document.getElementById('model-params-card').classList.add('hidden');
        document.getElementById('dose-optimizer-card').classList.add('hidden');

    } else {
        alert(`No data found for patient: ${patientName}`);
        clearAllData(false); // Clear board, but keep name
    }
}

function clearAllData(clearName = true) {
    if (clearName) {
        document.getElementById('patient-name').value = '';
    }
    document.getElementById('weight').value = 60;
    document.getElementById('hematocrit').value = 31;
    document.getElementById('mpa').value = '1';
    document.getElementById('bioassay').value = '1';
    document.getElementById('genotype').value = 'unknown';
    clinicalData = [];
    
    document.getElementById('transplant-date')._flatpickr.clear();
    setSmartDefaults();
    
    renderDoseLog();
    renderLevelLog();

    // Hide output sections
    document.getElementById('output-section').classList.add('hidden');
    document.getElementById('ipv-card').classList.add('hidden');
    document.getElementById('ttr-card').classList.add('hidden');
    document.getElementById('model-params-card').classList.add('hidden');
    document.getElementById('dose-optimizer-card').classList.add('hidden');

    // Reset optimizer
    lastForecastParams = { individual: null, population: null, allDoses: [], patientData: null };
    document.getElementById('optimizer-output').innerHTML = '<div class="text-center text-gray-500 italic">Run the main forecast first to enable this tool.</div>';
}

// --- NEW: Export to CSV Function ---
function exportPatientDataToCSV() {
    const patientName = document.getElementById('patient-name').value.trim();
    if (!patientName) {
        alert('Please load or enter a patient name first.');
        return;
    }

    let csvContent = "data:text/csv;charset=utf-8,";
    
    // Patient Demographics
    csvContent += "Patient Demographics\n";
    csvContent += "Patient_Name,Transplant_Date,Weight_kg,Hematocrit_pct,MPA_Coadmin,Genotype,Bioassay_Type\n";
    const patientData = {
        name: patientName,
        transplantDate: document.getElementById('transplant-date')._flatpickr.input.value,
        weight: document.getElementById('weight').value,
        hct: document.getElementById('hematocrit').value,
        mpa: document.getElementById('mpa').options[document.getElementById('mpa').selectedIndex].text,
        genotype: document.getElementById('genotype').options[document.getElementById('genotype').selectedIndex].text,
        bioassay: document.getElementById('bioassay').options[document.getElementById('bioassay').selectedIndex].text,
    };
    csvContent += `"${patientData.name}","${patientData.transplantDate}",${patientData.weight},${patientData.hct},"${patientData.mpa}","${patientData.genotype}","${patientData.bioassay}"\n`;

    // Spacer
    csvContent += "\nClinical Data Log\n";

    // Clinical Data
    csvContent += "DateTime,Dose_mg,Level_ng_mL\n";
    clinicalData.forEach(record => {
        csvContent += `"${record.datetime}",${record.dose !== null ? record.dose : ''},${record.level !== null ? record.level : ''}\n`;
    });

    // Create and trigger download
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `${patientName}_tacrolimus_data.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}


// --- UI Modals & Data Entry ---
/**
 * Adds a full day of default doses (07:00 and 19:00) with one click.
 */
function addDefaultDoseDay() {
    const lastRecord = clinicalData.length > 0 ? clinicalData[clinicalData.length - 1] : null;
    
    let newDoseDate;
    if (lastRecord) {
        // Find the last record *with a date*
        newDoseDate = dayjs(lastRecord.datetime).startOf('day').add(1, 'day');
    } else {
        const transplantDateStr = document.getElementById('transplant-date')._flatpickr.input.value;
        if (!transplantDateStr) {
             alert("Please set a valid transplant date before logging doses.");
             return;
        }
        newDoseDate = dayjs(transplantDateStr, "YYYY-MM-DD").add(1, 'day');
    }

    if (!newDoseDate.isValid()) {
        alert("Please set a valid transplant date before logging doses.");
        return;
    }

    // Find the last *dose* amount to use as the default
    const lastDoseRecord = [...clinicalData].reverse().find(r => r.dose !== null);
    const defaultDoseValue = lastDoseRecord ? lastDoseRecord.dose : 2.0;

    const morningDose = {
        datetime: newDoseDate.hour(7).minute(0).format("YYYY-MM-DD HH:mm"),
        dose: defaultDoseValue,
        level: null
    };
    const eveningDose = {
        datetime: newDoseDate.hour(19).minute(0).format("YYYY-MM-DD HH:mm"),
        dose: defaultDoseValue,
        level: null
    };

    // Check if these exact times already exist
    if (!clinicalData.find(r => r.datetime === morningDose.datetime)) {
        clinicalData.push(morningDose);
    }
    if (!clinicalData.find(r => r.datetime === eveningDose.datetime)) {
        clinicalData.push(eveningDose);
    }
    
    clinicalData.sort((a, b) => dayjs(a.datetime).diff(dayjs(b.datetime)));
    renderDoseLog();
    renderLevelLog();
}


function showAddRecordModal(type, editIndex = null) {
    const modal = document.getElementById('addRecordModal');
    document.getElementById('recordType').value = type;
    document.getElementById('editIndex').value = editIndex !== null ? editIndex : '';
    
    document.getElementById('dose-input-container').style.display = type === 'dose' ? 'block' : 'none';
    document.getElementById('level-input-container').style.display = type === 'level' ? 'block' : 'none';

    let defaultDate, record;
    if (editIndex !== null) {
        document.getElementById('modal-title').textContent = `Edit ${type === 'dose' ? 'Dose' : 'Level'} Record`;
        record = clinicalData[editIndex];
        defaultDate = record.datetime;
        document.getElementById('newDose').value = record.dose || '';
        document.getElementById('newLevel').value = record.level || '';
    } else { // This path is now only for adding new lab levels
        document.getElementById('modal-title').textContent = `Add Lab Result`;
        const lastRecordTime = clinicalData.length > 0 ? dayjs(clinicalData[clinicalData.length - 1].datetime) : dayjs().subtract(12, 'hour');
        defaultDate = lastRecordTime.add(11.5, 'hour').toDate();
        document.getElementById('newDose').value = '';
        document.getElementById('newLevel').value = '';
    }
    
    flatpickr("#newDateTime", { enableTime: true, altInput: true, altFormat: "d-M-y H:i", dateFormat: "Y-m-d H:i", defaultDate: defaultDate });
    document.getElementById('save-record-btn').onclick = saveRecord;
    modal.classList.remove('hidden');
    modal.classList.add('flex');
}

function hideAddRecordModal() {
    document.getElementById('addRecordModal').classList.add('hidden');
    document.getElementById('addRecordModal').classList.remove('flex');
}

function saveRecord() {
    const datetimeStr = document.getElementById('newDateTime').value;
    const dose = document.getElementById('newDose').value;
    const level = document.getElementById('newLevel').value;
    const index = document.getElementById('editIndex').value;
    const type = document.getElementById('recordType').value;

    if (!datetimeStr || !dayjs(datetimeStr).isValid()) { alert('Please enter a valid date and time.'); return; }
    if ((type === 'dose' && parseFloat(dose) < 0) || (type === 'level' && parseFloat(level) < 0)) {
        alert('Dose and level values cannot be negative.'); return;
    }
    const datetime = dayjs(datetimeStr).format("YYYY-MM-DD HH:mm");

    if (index !== '') { // Editing existing record
        clinicalData[parseInt(index)].datetime = datetime;
        if (type === 'dose') clinicalData[parseInt(index)].dose = dose ? parseFloat(dose) : null;
        if (type === 'level') clinicalData[parseInt(index)].level = level ? parseFloat(level) : null;
    } else { // Adding new record
        const existingRecord = clinicalData.find(r => r.datetime === datetime);
        if (existingRecord) { // Merge with a record at the same time
            if (type === 'dose') existingRecord.dose = dose ? parseFloat(dose) : null;
            if (type === 'level') existingRecord.level = level ? parseFloat(level) : null;
        } else { // No record at this time, so create a new one
            clinicalData.push({
                datetime: datetime,
                dose: type === 'dose' ? (dose ? parseFloat(dose) : null) : null,
                level: type === 'level' ? (level ? parseFloat(level) : null) : null,
            });
        }
    }
    
    clinicalData.sort((a, b) => dayjs(a.datetime).diff(dayjs(b.datetime)));
    renderDoseLog();
    renderLevelLog();
    hideAddRecordModal();
}

function deleteRecord(index, type) {
    if (confirm(`Are you sure you want to delete this ${type}?`)) {
        const record = clinicalData[index];
        if (type === 'dose') record.dose = null;
        if (type === 'level') record.level = null;
        if (record.dose === null && record.level === null) clinicalData.splice(index, 1);
        renderDoseLog();
        renderLevelLog();
    }
}


// --- UI Rendering ---
function getLevelStatus(level, date, transplantDate) {
    const range = getTherapeuticRange(date, transplantDate);
    if (isNaN(level)) return { text: 'N/A', class: '' };
    if (level < range.low) return { text: 'Low', class: 'level-low' };
    if (level > range.high) return { text: 'High', class: 'level-high' };
    return { text: 'Target', class: 'level-target' };
}

function renderDoseLog() {
    const tbody = document.getElementById('doseLogTable');
    const doseRows = clinicalData.map((record, index) => record.dose !== null ? `
        <tr class="border-b border-gray-100 text-sm hover:bg-gray-50">
            <td class="py-3 px-4">${dayjs(record.datetime).format('DD-MMM-YY HH:mm')}</td>
            <td class="py-3 px-4">${record.dose.toFixed(1)}</td>
            <td class="py-3 px-4 text-right">
                <button onclick="showAddRecordModal('dose', ${index})" class="text-indigo-600 hover:text-indigo-800 font-medium">Edit</button>
                <button onclick="deleteRecord(${index}, 'dose')" class="text-red-600 hover:text-red-800 font-medium ml-3">Delete</button>
            </td>
        </tr>` : '').join('');
    tbody.innerHTML = doseRows || `<tr><td colspan="3" class="text-center py-4 text-gray-500">No doses logged.</td></tr>`;
    saveToLocalStorage(); // Auto-save on change
}

function renderLevelLog() {
    const tbody = document.getElementById('levelLogTable');
    const transplantDate = dayjs(document.getElementById('transplant-date')._flatpickr.input.value, "YYYY-MM-DD");
    
    const levelRows = clinicalData.map((record, index) => {
        if (record.level !== null) {
            const status = getLevelStatus(record.level, dayjs(record.datetime), transplantDate);
            return `<tr class="border-b border-gray-100 text-sm hover:bg-gray-50">
                        <td class="py-3 px-4">${dayjs(record.datetime).format('DD-MMM-YY HH:mm')}</td>
                        <td class="py-3 px-4 font-medium">${record.level.toFixed(1)}</td>
                        <td class="py-3 px-4"><span class="status-indicator ${status.class}"></span>${status.text}</td>
                        <td class="py-3 px-4 text-right">
                            <button onclick="showAddRecordModal('level', ${index})" class="text-indigo-600 hover:text-indigo-800 font-medium">Edit</button>
                            <button onclick="deleteRecord(${index}, 'level')" class="text-red-600 hover:text-red-800 font-medium ml-3">Delete</button>
                        </td>
                    </tr>`;
        }
        return '';
    }).join('');
    tbody.innerHTML = levelRows || `<tr><td colspan="4" class="text-center py-4 text-gray-500">No levels logged.</td></tr>`;
    saveToLocalStorage(); // Auto-save on change
}

// --- Main Analysis Pipeline ---
async function runAllAnalyses() {
    const runBtn = document.getElementById('run-all-btn');
    runBtn.disabled = true; runBtn.textContent = 'Running...';

    // Reset optimizer and params
    lastForecastParams = { individual: null, population: null, allDoses: [], patientData: null };
    document.getElementById('dose-optimizer-card').classList.add('hidden');
    document.getElementById('model-params-card').classList.add('hidden');
    document.getElementById('optimizer-output').innerHTML = '<div class="text-center text-gray-500 italic">Run the main forecast first to enable this tool.</div>';

    try {
        const { patientData, historyLog, predictionDate } = gatherDataFromState();
        
        // Show all output cards
        document.getElementById('output-section').classList.remove('hidden');
        document.getElementById('ipv-card').classList.remove('hidden');
        document.getElementById('ttr-card').classList.remove('hidden');
        document.getElementById('model-params-card').classList.remove('hidden'); // NEW
        
        runIpvAndMetabolizer(historyLog);
        runTTRCalculation(historyLog, patientData.transplantDate);
        
        // Pass predictionDate to the forecast
        await runForecast(patientData, historyLog, predictionDate);

        // NEW: Show optimizer card only on successful forecast
        if (lastForecastParams.individual) {
            document.getElementById('dose-optimizer-card').classList.remove('hidden');
            // Set optimizer default date
            const lastDoseDate = historyLog.filter(r => r.dose).pop()?.recordDate || dayjs();
            const optimizerDefaultDate = lastDoseDate.add(4, 'day').hour(7).minute(0).toDate();
            document.getElementById('target-date-input')._flatpickr.setDate(optimizerDefaultDate, true);
        }

    } catch (error) {
        alert(`Critical Error: ${error.message}`);
        console.error(error);
    } finally {
        runBtn.disabled = false; runBtn.textContent = 'Run Individualized Forecast';
    }
}

function gatherDataFromState() {
    const transplantDate = dayjs(document.getElementById('transplant-date')._flatpickr.input.value, "YYYY-MM-DD");
    if (!transplantDate.isValid()) throw new Error("Invalid Transplant Date.");
    
    const predictionDate = dayjs(document.getElementById('prediction-datetime')._flatpickr.input.value, "YYYY-MM-DD HH:mm");
    if (!predictionDate.isValid()) throw new Error("Invalid Forecast Date.");

    const patientData = {
        weight: parseFloat(document.getElementById('weight').value),
        hct: parseFloat(document.getElementById('hematocrit').value), // Retained for Quick HCT tool
        mpa: parseInt(document.getElementById('mpa').value, 10),
        bioassay: parseInt(document.getElementById('bioassay').value, 10),
        genotype: document.getElementById('genotype').value,
        transplantDate: transplantDate,
    };

    const historyLog = clinicalData.map((record, index) => {
        const recordDate = dayjs(record.datetime);
        if (recordDate.isBefore(patientData.transplantDate.startOf('day'))) {
            throw new Error(`Log entry for ${recordDate.format('DD-MMM-YY')} cannot be before the transplant date.`);
        }
        return {
            id: index,
            recordDate: recordDate,
            dose: record.dose,
            level: record.level,
            time: recordDate.diff(patientData.transplantDate, 'hour', true)
        };
    });
    return { patientData, historyLog, predictionDate };
}

// --- Clinical Calculation Modules ---

/**
 * Returns the therapeutic range based on the time since transplant.
 */
function getTherapeuticRange(date, transplantDate) {
    const monthsPostTx = dayjs(date).diff(dayjs(transplantDate), 'month', true);
    if (monthsPostTx <= 1) return { low: 10, high: 11 };
    if (monthsPostTx > 1 && monthsPostTx <= 3) return { low: 7, high: 9 };
    if (monthsPostTx > 3 && monthsPostTx <= 6) return { low: 5, high: 7 };
    return { low: 4, high: 6 }; // More than 6 months
}

function runQuickHctAdjustment() {
    const outputDiv = document.getElementById('quick-hct-output');
    const Cwb = parseFloat(document.getElementById('quick-hct-level').value);
    const initialHct = parseFloat(document.getElementById('quick-hct-initial').value);
    const targetHct = 35; // Target HCT for this tool
    
    if (isNaN(Cwb) || isNaN(initialHct) || Cwb <= 0 || initialHct <= 0 || initialHct >= 100) {
        outputDiv.innerHTML = 'Adjusted Level: --';
        return;
    }

    const { HCT_ADJ_BMAX: Bmax, HCT_ADJ_KD: Kd } = PK_CONSTANTS;
    // C_plasma = (-b + sqrt(b^2 - 4ac)) / 2a
    const calculatePlasmaConc = (c_wb, fHCT) => {
        const a = 1 - fHCT;
        const b = Kd - c_wb - (fHCT * Kd) + (fHCT * Bmax);
        const c = -c_wb * Kd;
        return (-b + Math.sqrt(b * b - 4 * a * c)) / (2 * a);
    };
    // C_wb = C_p(1 - HCT) + HCT * (Bmax * C_p) / (Kd + C_p)
    const calculateWholeBloodConc = (c_p, fHCT) => c_p * (1 - fHCT) + fHCT * (Bmax * c_p) / (Kd + c_p);
    
    const currentPlasmaConc = calculatePlasmaConc(Cwb, initialHct / 100);
    const targetWholeBloodConc = calculateWholeBloodConc(currentPlasmaConc, targetHct / 100);
    
    outputDiv.innerHTML = `Adjusted Level: <span class="text-indigo-600">${targetWholeBloodConc.toFixed(1)} ng/mL</span>`;
}

function runIpvAndMetabolizer(historyLog) {
    const outputDiv = document.getElementById('ipv-output');
    const levels = historyLog.filter(e => e.level !== null && e.level > 0).sort((a, b) => a.time - b.time);
    const allDoses = historyLog.filter(e => e.dose !== null && e.dose > 0);

    if (levels.length < 3) return displayMessage(outputDiv, `Need at least 3 measured levels.`, 'info');
    
    const cdPairs = levels.map(levelEvent => {
        // Find all doses in the 24-hour period *before* this lab draw
        const priorDoses = allDoses.filter(d => 
            d.time < levelEvent.time && 
            d.time >= (levelEvent.time - 24)
        );
        
        if (priorDoses.length === 0) return null;

        // Sum them up to get the Total Daily Dose (TDD)
        const dailyDose = priorDoses.reduce((sum, d) => sum + d.dose, 0);

        return dailyDose > 0 ? { ratio: levelEvent.level / dailyDose } : null;
    }).filter(Boolean); // Remove nulls

    if (cdPairs.length < 2) { // Need at least 2 pairs to calc variability
        return displayMessage(outputDiv, `Could only form ${cdPairs.length} C/D pairs. Please ensure labs are preceded by at least one dose in the prior 24h.`, 'error');
    }

    const ratios = cdPairs.map(p => p.ratio);
    const avgRatio = ratios.reduce((a, b) => a + b, 0) / ratios.length;
    // Median Absolute Deviation (MAD)
    const mad = ratios.reduce((a, b) => a + Math.abs(b - avgRatio), 0) / ratios.length;
    const ipv = (mad / avgRatio) * 100;
    
    const status = avgRatio < 1.05 ? 'Fast Metabolizer' : 'Slow Metabolizer';
    const note = status === 'Fast Metabolizer' ? 'Higher risk of nephrotoxicity at similar troughs.' : 'May require lower doses for target.';

    let message = `<div class="grid grid-cols-2 gap-4 text-center">
        <div><div class="text-sm text-gray-500">Intra-Patient IPV</div><div class="font-bold text-2xl text-purple-700">${ipv.toFixed(1)}%</div></div>
        <div><div class="text-sm text-gray-500">C/D Ratio (Metabolism)</div><div class="font-bold text-lg text-purple-700">${avgRatio.toFixed(1)} (${status})</div></div>
        </div><div class="text-sm text-center mt-3 italic text-gray-600">${note}</div>`;
    displayMessage(outputDiv, message, 'success');
}

function runTTRCalculation(historyLog, transplantDate) {
    const outputDiv = document.getElementById('ttr-output');
    const levels = historyLog.filter(e => e.level !== null && e.level > 0).sort((a, b) => a.time - b.time);

    if (levels.length < 2) {
        return displayMessage(outputDiv, 'Requires at least 2 lab results to calculate.', 'info');
    }

    let totalTimeInRange = 0;
    let totalDuration = 0;

    for (let i = 0; i < levels.length - 1; i++) {
        const p1 = levels[i];
        const p2 = levels[i + 1];

        const intervalDuration = p2.time - p1.time;
        if (intervalDuration <= 0) continue;
        totalDuration += intervalDuration;
        
        const range = getTherapeuticRange(p1.recordDate, transplantDate);
        const { low: targetLow, high: targetHigh } = range;
        
        const v1 = p1.level;
        const v2 = p2.level;

        // --- Rosendaal Method (Linear Interpolation) ---
        if (v1 >= targetLow && v1 <= targetHigh && v2 >= targetLow && v2 <= targetHigh) {
            // Both points in range
            totalTimeInRange += intervalDuration;
            continue;
        }
        if ((v1 < targetLow && v2 < targetLow) || (v1 > targetHigh && v2 > targetHigh)) {
            // Both points out of range on the same side
            continue;
        }

        // --- Find crossing points ---
        const timeToCross = (target, val1, val2, time1, time2) => {
             if (val2 === val1) return time1;
             return time1 + (time2 - time1) * (target - val1) / (val2 - val1);
        };

        const t_low = timeToCross(targetLow, v1, v2, p1.time, p2.time);
        const t_high = timeToCross(targetHigh, v1, v2, p1.time, p2.time);
        
        const sortedTimes = [p1.time, p2.time, t_low, t_high].filter(t => t >= p1.time && t <= p2.time).sort((a, b) => a - b);
        let intervalTimeInRange = 0;

        for (let j = 0; j < sortedTimes.length - 1; j++) {
            const t_start = sortedTimes[j];
            const t_end = sortedTimes[j+1];
            const t_mid = t_start + (t_end - t_start) / 2;
            
            // Get concentration at midpoint
            const mid_conc = v1 + (v2 - v1) * (t_mid - p1.time) / (p2.time - p1.time);
            
            if (mid_conc >= targetLow && mid_conc <= targetHigh) {
                intervalTimeInRange += (t_end - t_start);
            }
        }
        totalTimeInRange += intervalTimeInRange;
    }

    if (totalDuration === 0) {
        return displayMessage(outputDiv, 'Not enough time elapsed between labs to calculate.', 'info');
    }

    const ttrPercentage = (totalTimeInRange / totalDuration) * 100;
    const message = `<div class="text-center">
            <div class="font-bold text-4xl text-purple-600">${ttrPercentage.toFixed(1)}%</div>
            <div class="text-sm text-gray-500 mt-1">Calculated using the Rosendaal method.</div>
        </div>`;
    displayMessage(outputDiv, message, 'success');
}


function runForecast(patientData, historyLog, predictionDate) {
    return new Promise((resolve) => {
        document.getElementById('forecast-loader').classList.remove('hidden');
        setTimeout(() => { 
            try {
                const loggedDoses = historyLog.filter(e => e.dose !== null && e.dose > 0);
                const measuredLevels = historyLog.filter(e => e.level !== null && e.level > 0);
                
                if (loggedDoses.length === 0) {
                    throw new Error("No doses logged. Cannot run forecast.");
                }

                // Extrapolate doses 14 days past the prediction date for a good graph
                const forecastUntilDate = predictionDate.add(14, 'day');
                const extrapolatedDoses = extrapolateDoses(historyLog, forecastUntilDate, patientData.transplantDate);
                const allDosesForModel = [...loggedDoses, ...extrapolatedDoses];
                
                const popParams = getPopulationParameters(patientData);
                const individualParams = getIndividualParameters(popParams, measuredLevels, allDosesForModel, patientData.bioassay);
                
                // --- NEW: Save parameters for other tools ---
                lastForecastParams = {
                    individual: individualParams,
                    population: popParams,
                    allDoses: allDosesForModel,
                    patientData: patientData
                };
                
                const lastTime = Math.max(forecastUntilDate.diff(patientData.transplantDate, 'hour', true), ...historyLog.map(l => l.time), 0);
                const timePoints = Array.from({length: 500}, (_, i) => (lastTime / 499) * i);
                
                const popCurve = generateCurve(timePoints, allDosesForModel, popParams, patientData.bioassay);
                const indCurve = generateCurve(timePoints, allDosesForModel, individualParams, patientData.bioassay);

                const predictedLevel = generateCurve(
                    [predictionDate.diff(patientData.transplantDate, 'hour', true)],
                     allDosesForModel, individualParams, patientData.bioassay)[0];
                
                updateChart(timePoints, popCurve, indCurve, measuredLevels, patientData.transplantDate);
                updateSummary(predictedLevel, predictionDate, individualParams.rmse);
                
                // NEW: Update Model Params card
                updateModelParamsCard(popParams, individualParams);

                resolve();
            } catch (error) {
                const summaryDiv = document.getElementById('results-summary');
                displayMessage(summaryDiv, error.message, 'error');
                summaryDiv.classList.remove('hidden');
                console.error("Forecast Error:", error);
                resolve(); // Resolve promise even on error
            } finally {
                document.getElementById('forecast-loader').classList.add('hidden');
            }
        }, 250); // Simulate processing time
    });
}

/**
 * Auto-fills doses based on the last logged dose, assuming a 12-hour (BID) schedule.
 */
function extrapolateDoses(historyLog, forecastUntilDate, transplantDate) {
    const extrapolatedDoses = [];
    const loggedDoses = historyLog.filter(e => e.dose !== null && e.dose > 0).sort((a, b) => a.time - b.time);
    
    if (loggedDoses.length === 0) {
        return []; // Cannot extrapolate without at least one dose
    }

    const lastLoggedDose = loggedDoses[loggedDoses.length - 1];
    let nextDoseTime = lastLoggedDose.recordDate.add(12, 'hour');
    
    while (nextDoseTime.isBefore(forecastUntilDate)) {
        extrapolatedDoses.push({
            id: 'extrapolated-' + extrapolatedDoses.length,
            recordDate: nextDoseTime,
            dose: lastLoggedDose.dose, // Use the last logged dose amount
            level: null,
            time: nextDoseTime.diff(transplantDate, 'hour', true)
        });
        nextDoseTime = nextDoseTime.add(12, 'hour');
    }
    return extrapolatedDoses;
}


// --- Pharmacokinetic Modeling ---

/**
 * UPDATED: Calculates Population PK Parameters based on Indian context.
 */
function getPopulationParameters(patientData) {
    const { weight, genotype } = patientData;
    const { TVCL, TVV, TVKA } = PK_CONSTANTS;

    const multiplier = CYP3A5_MULTIPLIER[genotype] || CYP3A5_MULTIPLIER['unknown'];
    const CL = TVCL * Math.pow(weight / 70, 0.75) * multiplier;
    const V = TVV * (weight / 70);
    
    return { CL: CL, V: V, KA: TVKA };
}


function getIndividualParameters(popParams, measuredLevels, allDoses, bioassay) {
    if (measuredLevels.length === 0) {
        return { ...popParams, rmse: null }; // No data, use population params
    }

    let bestEtaCL = 0, minError = Infinity;
    
    // Constrain the search range for 'eta'
    for (let eta = -1.2; eta <= 1.2; eta += 0.02) { 
        const testParams = { ...popParams, CL: popParams.CL * Math.exp(eta) };
        const predictedLevels = generateCurve(measuredLevels.map(l => l.time), allDoses, testParams, bioassay);
        
        // Calculate squared error
        const currentError = measuredLevels.reduce((sum, level, i) => {
            return sum + Math.pow(predictedLevels[i] - level.level, 2);
        }, 0);

        if (currentError < minError) {
            minError = currentError;
            bestEtaCL = eta;
        }
    }
    
    return { 
        CL: popParams.CL * Math.exp(bestEtaCL), 
        V: popParams.V, 
        KA: popParams.KA, 
        rmse: Math.sqrt(minError / measuredLevels.length) 
    };
}

/**
 * Core 1-compartment model prediction logic.
 */
function predictSingleDoseConcentration(time, dose_mg, params) {
    const { CL, V, KA } = params;
    if (time <= 0 || V <= 0) return 0;
    
    const dose_mcg = dose_mg * 1000;
    const k = CL / V;

    if (Math.abs(KA - k) < 1e-6) { // Handle case where KA = k
        return (dose_mcg * KA * time * Math.exp(-k * time)) / V;
    }

    const coefficient = (dose_mcg * KA) / (V * (KA - k));
    const concentrations = Math.exp(-k * time) - Math.exp(-KA * time);
    
    return coefficient * concentrations;
}

function generateCurve(times_to_plot, allDoseEvents, params, bioassay) {
    const concentrations = times_to_plot.map(currentTime => {
        // Superposition: sum the concentration from all prior doses
        const totalConcentration = allDoseEvents.reduce((sum, doseEvent) => {
            if (doseEvent.time < currentTime) {
                const timeSinceDose = currentTime - doseEvent.time;
                return sum + predictSingleDoseConcentration(timeSinceDose, doseEvent.dose, params);
            }
            return sum;
        }, 0);
        return totalConcentration;
    });

    // Apply CMIA correction if needed
    return bioassay === 2 ? concentrations.map(c => 1.08 * c + 0.55) : concentrations;
}


// --- Charting and Display ---
function displayMessage(divElement, message, type) {
    divElement.innerHTML = `<div class="output-${type}">${message}</div>`;
}

function updateChart(timePoints, popCurve, indCurve, measuredLevels, transplantDate) {
    const ctx = document.getElementById('concentration-chart').getContext('2d');
    
    const datasets = [{
        label: 'Population Prediction', data: popCurve.map((y, i) => ({ x: timePoints[i], y })),
        borderColor: 'rgba(107, 114, 128, 0.8)', borderWidth: 2, pointRadius: 0, tension: 0.4, borderDash: [5, 5]
    },{
        label: 'Individualized Forecast', data: indCurve.map((y, i) => ({ x: timePoints[i], y })),
        borderColor: 'rgb(37, 99, 235)', borderWidth: 3, pointRadius: 0, tension: 0.4,
    }];

    if (measuredLevels.length > 0) {
        datasets.push({
            label: 'Measured Levels', data: measuredLevels.map(l => ({ x: l.time, y: l.level })),
            backgroundColor: 'rgb(220, 38, 38)', pointRadius: 5, pointHoverRadius: 7, type: 'scatter', showLine: false
        });
    }
    
    if (myChart) myChart.destroy();

    myChart = new Chart(ctx, {
        type: 'line', data: { datasets },
        options: {
            responsive: true, maintainAspectRatio: false,
            scales: {
                x: { type: 'linear', position: 'bottom', title: { display: true, text: 'Hours Post-Transplant', font: { size: 14 }}},
                y: { title: { display: true, text: 'Tacrolimus (ng/mL)', font: { size: 14 }}, min: 0 }
            },
            plugins: {
                legend: { position: 'top' },
                tooltip: { 
                    callbacks: { 
                        title: ctx => `Hour ${ctx[0].parsed.x.toFixed(1)} (${transplantDate.add(ctx[0].parsed.x, 'hour').format('DD-MMM-YY HH:mm')})` 
                    }
                }
            },
            interaction: { intersect: false, mode: 'index' }
        },
        plugins: [{
            id: 'targetRange',
            beforeDraw: (chart) => {
                const { ctx, chartArea: { left, right }, scales: { x, y } } = chart;
                ctx.save();
                
                const dateRanges = [];
                let lastRangeKey = '';

                timePoints.forEach(hour => {
                    const date = transplantDate.add(hour, 'hour');
                    const range = getTherapeuticRange(date, transplantDate);
                    const key = `${range.low}-${range.high}`;
                    if (key !== lastRangeKey) {
                        dateRanges.push({ startHour: hour, range: range });
                        lastRangeKey = key;
                    }
                });
                
                dateRanges.forEach((r, i) => {
                    const startPixel = x.getPixelForValue(r.startHour);
                    const endPixel = (i + 1 < dateRanges.length) ? x.getPixelForValue(dateRanges[i+1].startHour) : right;
                    const yMinPixel = y.getPixelForValue(r.range.high);
                    const yMaxPixel = y.getPixelForValue(r.range.low);

                    ctx.fillStyle = 'rgba(252, 211, 77, 0.2)'; // Yellowish tint for target range
                    const drawX = Math.max(startPixel, left);
                    const drawWidth = Math.min(endPixel, right) - drawX;
                    if (drawWidth > 0) {
                         ctx.fillRect(drawX, yMinPixel, drawWidth, yMaxPixel - yMinPixel);
                    }
                });
                ctx.restore();
            }
        }]
    });
}

function updateSummary(predictedLevel, predictionDate, rmse) {
    const summaryDiv = document.getElementById('results-summary');
    const rmseHtml = rmse ? `Model Fit (RMSE): <span class="font-semibold ${rmse > 2.0 ? 'text-red-600' : 'text-green-600'}">${rmse.toFixed(2)} ng/mL</span>` : '';
    if (predictionDate && !isNaN(predictedLevel)) {
        summaryDiv.innerHTML = `Predicted Level at <span class="text-indigo-700">${predictionDate.format('DD-MMM-YY HH:mm')}</span> is <span class="text-3xl font-bold text-indigo-600">${predictedLevel.toFixed(1)}</span> ng/mL
        <div class="text-sm mt-1 text-gray-600">${rmseHtml}</div>`;
    } else {
         summaryDiv.innerHTML = 'Could not calculate a prediction. Please check inputs.';
    }
    summaryDiv.classList.remove('hidden');
}

// --- NEW: Update Model Params Card Function ---
function updateModelParamsCard(popParams, indParams) {
    const outputDiv = document.getElementById('model-params-output');
    if (!indParams || indParams.rmse === null) {
        displayMessage(outputDiv, 'Run forecast with measured levels to see parameters.', 'info');
        return;
    }

    let interpretation = "Normal Metabolizer";
    const ratio = indParams.CL / popParams.CL;
    if (ratio > 1.25) interpretation = "Fast Metabolizer (Higher CL)";
    if (ratio < 0.75) interpretation = "Slow Metabolizer (Lower CL)";

    const message = `
        <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-left">
            <div class="text-sm text-gray-500">Model Fit (RMSE)</div>
            <div class="font-semibold text-right ${indParams.rmse > 2.0 ? 'text-red-600' : 'text-green-600'}">${indParams.rmse.toFixed(2)} ng/mL</div>
            
            <div class="text-sm text-gray-500">Population CL</div>
            <div class="font-semibold text-right">${popParams.CL.toFixed(1)} L/hr</div>
            
            <div class="text-sm text-gray-500">Individualized CL</div>
            <div class="font-semibold text-right">${indParams.CL.toFixed(1)} L/hr</div>
        </div>
        <div class="text-sm text-center mt-3 italic text-gray-600">
            Interpretation: <span class="font-medium text-gray-800">${interpretation}</span>
        </div>`;
    displayMessage(outputDiv, message, 'success');
}

// --- NEW: Dose Optimizer Function ---
function runDoseOptimizer() {
    const outputDiv = document.getElementById('optimizer-output');
    if (!lastForecastParams.individual) {
        displayMessage(outputDiv, 'You must run a successful forecast first (with a low RMSE) to enable this tool.', 'error');
        return;
    }

    const targetTrough = parseFloat(document.getElementById('target-trough-input').value);
    const targetDate = dayjs(document.getElementById('target-date-input')._flatpickr.input.value, "YYYY-MM-DD HH:mm");

    if (isNaN(targetTrough) || !targetDate.isValid()) {
        displayMessage(outputDiv, 'Please enter a valid target trough and target date.', 'error');
        return;
    }
    
    // Find the last *actual* dose event to start the new simulation from
    const lastLoggedDose = historyLog.filter(e => e.dose !== null && e.dose > 0).sort((a, b) => b.time - a.time)[0];
    if (!lastLoggedDose) {
         displayMessage(outputDiv, 'Cannot optimize without at least one logged dose.', 'error');
         return;
    }

    // Get all logged doses. We will simulate *from* the last logged dose.
    const loggedDoses = historyLog.filter(e => e.dose !== null && e.dose > 0);
    const simulationStartDate = lastLoggedDose.recordDate;
    
    // Dose strengths to simulate
    const dosesToTry = [0.5, 1.0, 1.5, 2.0, 2.5, 3.0, 3.5, 4.0, 4.5, 5.0];
    let results = [];
    
    // For each dose, simulate forward
    dosesToTry.forEach(testDose => {
        let simulatedDoses = [];
        let nextDoseTime = simulationStartDate.add(12, 'hour'); // Start from the *next* dose
        
        // Create a new dose history from the last logged dose
        while (nextDoseTime.isBefore(targetDate.add(2, 'hour'))) { // Simulate 2 hours past trough to get peak
            simulatedDoses.push({
                recordDate: nextDoseTime,
                dose: testDose,
                time: nextDoseTime.diff(lastForecastParams.patientData.transplantDate, 'hour', true)
            });
            nextDoseTime = nextDoseTime.add(12, 'hour');
        }
        
        // Combine history *before* the new regimen + the new simulated regimen
        const fullDoseHistory = [...loggedDoses, ...simulatedDoses];
        
        // Calculate Trough (at target date)
        const predictedTrough = generateCurve(
            [targetDate.diff(lastForecastParams.patientData.transplantDate, 'hour', true)],
            fullDoseHistory, 
            lastForecastParams.individual, 
            lastForecastParams.patientData.bioassay
        )[0];
        
        // Calculate Peak (2 hours after last dose)
        const peakTime = targetDate.add(2, 'hour');
         const predictedPeak = generateCurve(
            [peakTime.diff(lastForecastParams.patientData.transplantDate, 'hour', true)],
            fullDoseHistory, 
            lastForecastParams.individual, 
            lastForecastParams.patientData.bioassay
        )[0];

        results.push({
            dose: testDose,
            trough: predictedTrough,
            peak: predictedPeak,
            diff: Math.abs(predictedTrough - targetTrough)
        });
    });

    // Find the best dose
    results.sort((a, b) => a.diff - b.diff);
    const bestDose = results[0].dose;

    // Generate table
    let tableHtml = `
        <div class="overflow-x-auto -mx-6">
        <table class="w-full min-w-full">
            <thead><tr class="border-b border-gray-200 text-left text-sm font-semibold text-gray-600">
                <th class="py-3 px-4">Proposed Dose (BID)</th>
                <th class="py-3 px-4">Predicted Trough (C0)</th>
                <th class="py-3 px-4">Predicted Peak (C2)</th>
            </tr></thead>
            <tbody>`;
            
    results.sort((a, b) => a.dose - b.dose).forEach(res => {
        const highlightClass = res.dose === bestDose ? 'highlight-row' : '';
        tableHtml += `
            <tr class="border-b border-gray-100 text-sm hover:bg-gray-50 ${highlightClass}">
                <td class="py-3 px-4 font-medium">${res.dose.toFixed(1)} mg</td>
                <td class="py-3 px-4 font-bold">${res.trough.toFixed(1)} ng/mL</td>
                <td class="py-3 px-4">${res.peak.toFixed(1)} ng/mL</td>
            </tr>`;
    });
            
    tableHtml += `</tbody></table></div>
        <div class="text-sm text-center mt-3 italic text-gray-600">
            Note: This simulation starts from your <span class="font-medium">last logged dose</span> and assumes BID dosing.
        </div>`;
    outputDiv.innerHTML = tableHtml;
}


</script>

</body>
</html>


